# -----------------------------------------------------------------------------
#
# Create bootable usb on mac
#
Download image for usb-use.

http://www.webupd8.org/2009/04/4-ways-to-create-bootable-live-usb.html
4. Using Diskutil (Mac OS X only)

Download the desired .img file
Open a Terminal (under Utilities)
Run diskutil list to get the current list of devices
Insert your flash media
Run diskutil list again and determine the device node assigned to your flash media (e.g. /dev/disk2)
Run diskutil unmountDisk /dev/diskN
Execute sudo dd if=/path/to/downloaded.img of=/dev/diskN bs=1m
Run diskutil eject /dev/diskN and remove your flash media when the command completes


# -----------------------------------------------------------------------------
#
# Fresh minimal install and some neccessaties
#
# http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/ports-using.html
# 
install freebsd, minimal install

portsnap fetch
portsnap extract
portsnap update
cd /usr/ports/sysutils/screen && make install clean
cd /usr/ports/irc/irssi && make install clean
cd /usr/ports/devel/git && make install clean
cd /usr/ports/devel/subversion && make install clean
cd /usr/ports/net/rsync/ && make install clean
 add iconv support 
 add -atime
cd /usr/ports/archivers/zip && make install clean
cd /usr/ports/ftp/wget && make install clean

sysinstall & install manualpages Configure - Distributions - System Manual Pages

# have /tmp in memory
echo 'tmpmfs="YES"' >> /etc/rc.conf


# -----------------------------------------------------------------------------
#
# Apache
#
# Backup /usr/local/etc/apache22, its the config directory.
#
cd /usr/ports/www/apache22 && make install clean
echo 'apache22_enable="YES"' >> /etc/rc.conf
vi /usr/local/etc/apache22/httpd.conf 

# Include config file for virtualhosts from httpd.conf
Include etc/apache22/extra/httpd-vhosts.conf

# vi /usr/local/etc/apache22/extra/httpd-vhosts.conf
<URL:http://httpd.apache.org/docs/2.2/vhosts/>
<VirtualHost *:80>
    DocumentRoot "/usr/home/mos/htdocs/dbwebb.se"
    <Directory "/usr/home/mos/htdocs/dbwebb.se">
        Options Indexes FollowSymLinks
        AllowOverride None
        Order allow,deny
        Allow from all
    </Directory>
    ServerName dbwebb.se
    ServerAlias www.dbwebb.se
    ErrorLog "/usr/home/mos/htdocs/log/dbwebb.se-error_log"
    CustomLog "/usr/home/mos/htdocs/log/dbwebb.se-access_log" common
</VirtualHost>


# vi /usr/local/etc/apache22/Includes/httpd-hide-git-svn.conf 
<DirectoryMatch \.svn>
   Order allow,deny
   Deny from all
</DirectoryMatch>

<DirectoryMatch \.git>
   Order allow,deny
   Deny from all
</DirectoryMatch>

apachectl restart


#
# https
#
# http://onlamp.com/pub/a/onlamp/2008/03/04/step-by-step-configuring-ssl-under-apache.html
#
# Create certs
cd /usr/local/etc/apache22
openssl req -new -x509 -days 365 -sha1 -newkey rsa:1024 -nodes -keyout server.key -out server.crt -subj '/DC=se/DC=dbwebb/CN=ldap.dbwebb.se'
chmod 400 server.key 
ls -l /usr/local/etc/apache22/server.*
-rw-r--r--  1 root  wheel  993 Jun 10 09:32 /usr/local/etc/apache22/server.crt
-r--------  1 root  wheel  887 Jun 10 09:32 /usr/local/etc/apache22/server.key

vi httpd.conf
# Secure (SSL/TLS) connections
Include etc/apache22/extra/httpd-ssl.conf

apachectl restart


# -----------------------------------------------------------------------------
#
# MySQL
#
# http://dev.mysql.com/doc/refman/5.1/en/mysql-installation-freebsd.html
#
cd /usr/ports/databases/mysql51-client && make install clean
cd /usr/ports/databases/mysql51-server/ && make install clean
/usr/local/bin/mysql_install_db
chown -R mysql /var/db/mysql/
chgrp -R mysql /var/db/mysql/
echo 'mysql_enable="YES"' >> /etc/rc.conf
/usr/local/bin/mysqld_safe -user=mysql &
/usr/local/bin/mysqladmin -u root password newpassword
mysqladmin shutdown -p

# Configure
# http://dev.mysql.com/doc/refman/5.1/en/post-installation.html
#
mysql -u root -p
mysql> GRANT ALL ON *.* TO mos@localhost IDENTIFIED BY 'password';
mysql> SELECT User, Host, Password FROM mysql.user;
mysql> SET PASSWORD FOR 'root'@'localhost' = PASSWORD('password');
mysql> SET PASSWORD FOR 'root'@'kaprifolen.dbwebb.se' = PASSWORD('password');
mysql> SET PASSWORD FOR 'root'@'127.0.0.1' = PASSWORD('password');
mysql> DELETE FROM mysql.user WHERE User = '';

/usr/local/etc/rc.d/mysql-server restart


# -----------------------------------------------------------------------------
#
# PHP
# 
# Don't forget to check to build for apache.
#
cd /usr/ports/lang/php5 && make config install clean

cat /usr/local/etc/apache22/Includes/enable-php5.conf 
AddType application/x-httpd-php .php
AddType application/x-httpd-php-source .phps
#AddType application/x-httpd-php .php .htm .html

# Create the php.ini-file. Disable magic quotes, enable error reporting.
# Test configuration using Utility/check_php_config.php

cd /usr/ports/www/php5-session && make install clean
cd /usr/ports/databases/php5-mysqli && make install clean
cd /usr/ports/databases/php5-mysql && make install clean
cd /usr/ports/net/php5-ldap && make install clean
cd /usr/ports/databases/php5-pdo && make install clean
cd /usr/ports/databases/php5-pdo_sqlite && make install clean
cd /usr/ports/graphics/php5-gd && make install clean
cd /usr/ports/security/php5-hash ; make install clean
cd /usr/ports/security/php5-filter ; make install clean
cd /usr/ports/textproc/php5-xml ; make install clean
cd /usr/ports/converters/php5-mbstring ; make install clean
cd /usr/ports/textproc/php5-ctype ; make install clean
cd /usr/ports/textproc/php5-simplexml ; make install clean
cd /usr/ports/archivers/php5-zlib ; make install clean
cd /usr/ports/devel/php5-json ; make install clean
cd /usr/ports/devel/php5-tokenizer ; make install clean

apachectl restart



# -----------------------------------------------------------------------------
#
# OpenLDAP, using TSL
# 
# Instructions from Utility/ldap.ldif
#
cd /usr/ports/net/openldap24-server && make install clean
vi /usr/local/etc/openldap/slapd.conf
echo 'slapd_enable="YES"' >> /etc/rc.conf

/usr/local/etc/rc.d/slapd start
sockstat -4 -p 389


# Install client (if not already installed)
cd /usr/ports/net/openldap24-client && make install clean
cd /usr/ports/sysutils/ldapvi && make install clean

# Fill database with some content?
#
# Check if there is a namingContext
ldapsearch -x -b '' -s base '(objectclass=*)' namingContexts
#
# Add entries from file
ldapadd -x -D "cn=Manager,dc=dbwebb,dc=se" -W -f ldap.ldif
#
# Edit entries
ldapvi -D "cn=Manager,dc=dbwebb,dc=se" --discover


# Check that it works from PHP?
#
# http://dbwebb.se/utility/ldap.php


#
# Enable TLS and SSL (ldaps://)
#
vi /usr/local/etc/openldap/slapd.conf
Add ---
#security ssf=128
security tls=0
TLSCertificateFile    /usr/local/etc/openldap/ssl/server.crt
TLSCertificateKeyFile /usr/local/etc/openldap/ssl/server.key
TLSCACertificateFile  /usr/local/etc/openldap/ssl/server.crt
--- Stop add

# Copy the certificate from apache httpds or create a new ones
# and store them in /usr/local/etc/openldap/ssl
#
openssl req -new -x509 -days 365 -sha1 -newkey rsa:1024 -nodes -keyout server.key -out server.crt -subj '/DC=se/DC=dbwebb/CN=ldap.dbwebb.se'
chown ldap server.key
chmod 400 server.key 
ls -l /usr/local/etc/openldap/ssl
total 4
-rw-r--r--  1 root  wheel  993 Oct 29 04:53 server.crt
-r--------  1 ldap  wheel  887 Oct 29 04:53 server.key

# Start slapd to listen on both ldap:// and ldaps://
echo 'slapd_flags=\'-h "ldaps:/// ldap:///"\'' >> /etc/rc.conf

/usr/local/etc/rc.d/slapd restart
sockstat -4 -p "389,636"

# Client issue to NOT validate self-signed server cert
vi /usr/local/etc/openldap/ldap.conf
Add ---
TLS_REQCERT allow
--- stop add

# Test that TLS works using -Z
ldapsearch -Z -x -b '' -s base '(objectclass=*)' namingContexts
ldapvi -Z --tls allow -D "cn=Manager,dc=dbwebb,dc=se" --discover
# http://dbwebb.se/utility/ldap.php


# ---------------------------------------------------------------------------------
#
# Enable login through LDAP
#
# http://www.freebsd.org/doc/en/articles/ldap-auth/article.html
#
gm# cd security/pam_ldap/ ; make install clean ;

Create the config-file /usr/local/etc/ldap.conf, may be same settings as openldap/ldap.conf

Edit /etc/pam.d/sshd, add line:
auth            sufficient      /usr/local/lib/pam_ldap.se      no_warn
account         required        /usr/local/lib/pam_ldap.so      no_warn ignore_authinfo_unavail ignore_unknown_user

#
# Not needed to set up nss to allow getting guid&gid from LDAP
#
gm# cd /usr/ports/net/nss_ldap/; make install clean;
The nss_ldap module expects to find its configuration files at the
following paths:

LDAP configuration:     /usr/local/etc/nss_ldap.conf
LDAP secret (optional): /usr/local/etc/nss_ldap.secret
